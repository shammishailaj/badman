package source

import (
	"bufio"
	"strings"
	"time"

	"github.com/m-mizutani/badman"
)

// MalwareDomains downloads blacklist from http://www.malwaredomains.com/
type MalwareDomains struct {
	URL string
}

// NewMalwareDomains is constructor of MalwareDomains
func NewMalwareDomains() *MalwareDomains {
	return &MalwareDomains{
		URL: "http://mirror1.malwaredomains.com/files/domains.txt",
	}
}

// Download of MalwareDomains downloads domains.txt and parses to extract domain names.
func (x *MalwareDomains) Download() chan *badman.EntityQueue {
	ch := make(chan *badman.EntityQueue, defaultSourceChanSize)
	bufferSize := 128

	go func() {
		defer close(ch)
		buffer := []*badman.BadEntity{}

		now := time.Now()
		body := getHTTPBody(x.URL, ch)
		if body == nil {
			return
		}

		scanner := bufio.NewScanner(body)
		for scanner.Scan() {
			line := scanner.Text()
			if strings.HasPrefix(line, "#") {
				continue // Comment line
			}

			row := strings.Split(line, "\t")

			buffer = append(buffer, &badman.BadEntity{
				Name:    row[2],
				SavedAt: now,
				Src:     "MalwareDomains",
				Reason:  row[3],
			})

			if len(buffer) >= bufferSize {
				ch <- &badman.EntityQueue{Entities: buffer}
				buffer = []*badman.BadEntity{}
			}
		}

		if len(buffer) > 0 {
			ch <- &badman.EntityQueue{Entities: buffer}
		}
	}()

	return ch
}
